
% Preprocess data to calculate percentages
\pgfplotstableread[col sep=comma]{content/plots/policy_klassifikation_spezifisch_absolut.csv}\datatable
% Create total column
\pgfplotstablecreatecol[create col/expr={\thisrow{0-NA} + \thisrow{1-NOMENTION} + \thisrow{2-GWPMENTION} + \thisrow{3-GWPPFLICHT} + \thisrow{4-PRIMÄRDATENEMPFEHLUNG} + \thisrow{5-PRIMÄRDATENPFLICHT}}]{total}{\datatable}
\pgfplotsset{
    percentage plot/.style={
        ybar stacked,
        yticklabel=\pgfmathprintnumber{\tick}\,$\%$,
        bar width=18pt,
        point meta=explicit,
        every node near coord/.append style={
            font=\scriptsize\linespread{0.85}\selectfont,
            anchor=center,
            text width=2.5cm,
            align=center,
            yshift=0ex, % Adjust vertical position
            xshift=-.15em
        },
        nodes near coords={
            \pgfmathtruncatemacro\iszero{\originalvalue==0}
            \ifnum\iszero=0
                \centering\pgfmathprintnumber[fixed zerofill,precision=0]{\originalvalue}\\\hspace{.15em}(\pgfmathprintnumber[fixed zerofill,precision=0]{\pgfplotspointmeta})
            \fi
        },
        ymin=0,
        ymax=100,
        enlarge y limits={upper,value=0.18},
        visualization depends on={y \as \originalvalue}
    },
    percentage series/.style={
        table/y expr=\thisrow{#1}/\thisrow{total}*100,
        table/meta=#1
    }
}
\begin{tikzpicture}
    \begin{axis}[
        width=\textwidth,
        height=.7\textwidth,
        legend cell align={left},
        percentage plot,
        xticklabel style={font=\footnotesize,yshift=-2pt},
        ylabel={Anteil in Prozent (\%)},
        enlargelimits=0.075,
        legend style={
            at={(1,1.02)},
            anchor=south east,
            legend columns=3
        },
        symbolic x coords={
            DE-BW, DE-BY, DE-BE, DE-BB, 
            DE-HB, DE-HH, DE-HE, DE-MV, 
            DE-NI, DE-NW, DE-RP, 
            DE-SL, DE-SN, DE-ST, DE-SH, DE-TH
        },
        xtick=data,
        x tick label style={rotate=45,anchor=east},
    ]

    \addplot[fill=colorblindC9] table [percentage series=0-NA] {\datatable};
    \addplot[fill=colorblindC7] table [percentage series=1-NOMENTION] {\datatable};
    \addplot[fill=colorblindC5] table [percentage series=2-GWPMENTION] {\datatable};
    \addplot[fill=colorblindC6] table [percentage series=3-GWPPFLICHT] {\datatable};
    \addplot[fill=colorblindC2] table [percentage series=4-PRIMÄRDATENEMPFEHLUNG] {\datatable};
    \addplot[fill=colorblindC1] table [percentage series=5-PRIMÄRDATENPFLICHT] {\datatable};

    \legend{\strut Nicht zugänglich, \strut Keine \gls{forschungsdaten}-Richtlinie, \strut \gls{gwp}-Empfehlung, \strut \gls{gwp}-Pflicht, \strut \gls{forschungsdaten}-Empfehlung, \strut \gls{forschungsdaten}-Pflicht}
    \end{axis}
\end{tikzpicture}
\vspace{-3.5mm}